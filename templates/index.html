<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shapez2 Solver</title>
</head>
<body>
    <!-- a file type with id fileInput, that allow us to upload file -->
    <input type="file" id="fileInput">

    <!-- a canvas for us to click-->
    <canvas id="canvas" width="800" height="600" style="border:1px solid black;"></canvas>

    <!-- a button to call a script function -->
    <button id="submit_image">Submit image</button>
    
    <!-- a place to show the result as preformatted text -->
    <pre id="blueprint"></pre>

    <script>
        // -----------------------------------------------
        // data
        // -----------------------------------------------
        let leftClicks = [];
        let rightClicks = [];

        // -----------------------------------------------
        // get web page elements
        // -----------------------------------------------
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('canvas');
        const canvas_context = canvas.getContext('2d');
        const button_submit_image = document.getElementById('submit_image');
        
        // -----------------------------------------------
        // link element to callbacks
        // -----------------------------------------------
        canvas.addEventListener('mousedown', callback_canvas_clicks);
        button_submit_image.addEventListener('click', callback_submit_image);
        window.addEventListener('keydown', callback_keyboard);

        // -----------------------------------------------
        // callback functions
        // -----------------------------------------------
        function callback_canvas_clicks(event) 
        {
            // prevent right-click context menu
            canvas.oncontextmenu = () => false;

            function draw_clicks([x, y], color)
            {
                canvas_context.fillStyle = color; 
                canvas_context.beginPath(); 
                canvas_context.arc(x, y, 4, 0, 2*Math.PI);
                canvas_context.fill();
            }

            const rect = canvas.getBoundingClientRect();
            const pt = [event.clientX - rect.left, event.clientY - rect.top];
            // left
            if (event.button === 0) 
            {        
                leftClicks.push(pt);
                draw_clicks(pt, 'red');
            } 
            // right
            else if (event.button === 2) 
            {
                rightClicks.push(pt);
                draw_clicks(pt, 'blue');
            }
        }

        async function callback_submit_image() 
        {
            // if no file uploaded, alert
            if (document.getElementById('fileInput').files.length === 0) 
            {
                alert('Please upload a file first.');
                return;
            }

            // put the image on the canvas
            const file = document.getElementById('fileInput').files[0];
            const reader = new FileReader();
            reader.onload = function(event)
            {
                const img = new Image();
                img.onload = function() 
                {
                    canvas_context.clearRect(0, 0, canvas.width, canvas.height); // clear canvas
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Scale down visually
                    canvas.style.width = '800px';
                    canvas.style.height = 'auto';

                    canvas_context.drawImage(img, 0, 0, canvas.width, canvas.height); // draw image
                };
                img.src = event.target.result; // set image source to file content
            };
            reader.readAsDataURL(file); // read file as data URL

            // reset clicks
            leftClicks = [];
            rightClicks = [];
        }

        async function callback_keyboard(event)
        {
            if (event.key === 'Enter')
            {
                // get file uploaded
                const f = document.getElementById('fileInput').files[0];

                // get clicks
                const clicks = JSON.stringify({left: leftClicks, right: rightClicks});

                // convert both to form
                const form = new FormData();
                form.append('file', f);
                form.append('clicks', clicks);

                // submit to server and get task_id
                const {task_id} = await fetch('/uploads/', {method:'POST', body:form}).then(r=>r.json());

                // poll for result
                let result;
                do 
                { 
                    result = await fetch(`/result/${id}`).then(r=>r.json()); 
                    await new Promise(r=>setTimeout(r,1000)); 
                }
                while (!result.ready);
                
                // show result in the pre named blueprint
                document.getElementById('blueprint').textContent = result.blueprint;

                // draw the image on the canvas
                const img = new Image(); 
                img.src = `/static/results/${result.image}`;
                img.onload = () => canvas_context.drawImage(img,0,0);
            }
        }
    </script>
</body>
</html>
