<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shapez2 Solver</title>
</head>
<body>
    <!-- a file type with id fileInput, that allow us to upload file -->
    <input type="file" id="fileInput">

    <!-- a canvas for us to click-->
    <canvas id="canvas" width="800" height="600" style="border:1px solid black;"></canvas>
    
    <pre id="blueprint"></pre>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let leftClicks = [], rightClicks = [];
        
        // listen for clicks
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const pt = [e.clientX - rect.left, e.clientY - rect.top];
            if (e.button === 0) {        // left
                leftClicks.push(pt);
                drawMarker(pt, 'red');
            } else if (e.button === 2) { // right
                rightClicks.push(pt);
                drawMarker(pt, 'blue');
                e.preventDefault();      // suppress context menu
            }
        });

        // listen for "enter"
        window.addEventListener('keydown', e => {
            if (e.key === 'Enter') submitSolve();
        });

        async function submitSolve() {
            const f = document.getElementById('fileInput').files[0];
            const form = new FormData();
            form.append('file', f);
            form.append('clicks', JSON.stringify({left: leftClicks, right: rightClicks}));
            const {task_id} = await fetch('/uploads/', {method:'POST', body:form}).then(r=>r.json());
            pollResult(task_id);
        }
        async function pollResult(id) {
            let res;
            do { res = await fetch(`/result/${id}`).then(r=>r.json()); await new Promise(r=>setTimeout(r,1000)); }
            while (!res.ready);
            document.getElementById('blueprint').textContent = res.blueprint;
            const img = new Image(); img.src = `/static/results/${res.image}`;
            img.onload = () => ctx.drawImage(img,0,0);
        }
        function drawMarker([x,y], color){
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill();
        }
        canvas.oncontextmenu = () => false; // another safeguard
    </script>
</body>
</html>
