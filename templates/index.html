<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shapez2 Solver</title>
</head>
<body>
    <!-- a file type with id fileInput, that allow us to upload file -->
    <input type="file" id="fileInput">

    <!-- a canvas for us to click-->
    <canvas id="canvas" width="800" height="600" style="border:1px solid black;"></canvas>
    
    <!-- a button to call a script function -->
    <button id="submit_image">Submit image</button>

    <!-- a canvas to show preview -->
    <canvas id="simple_coordinates_canvas" width="800" height="600" style="border:1px solid black;"></canvas>
    
    <!-- a place to show the result as preformatted text -->
    <pre id="blueprint"></pre>

    <!-- include -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // -----------------------------------------------
        // data
        // -----------------------------------------------
        let leftClicks = [];
        let rightClicks = [];
        let task_id = null;

        // -----------------------------------------------
        // get web page elements
        // -----------------------------------------------
        const file_input = document.getElementById('fileInput'); 
        const preview_canvas = document.getElementById('canvas');
        const simple_coordinates_canvas = document.getElementById('simple_coordinates_canvas');
        const button_submit_image = document.getElementById('submit_image');
        const preformatted_text = document.getElementById('blueprint');
        
        // -----------------------------------------------
        // setup canvas
        // -----------------------------------------------
        const preview_canvas_width = 800;
        preview_canvas.style.width = `${preview_canvas_width}px`;
        preview_canvas.style.height = 'auto'; // set height to auto
        preview_canvas.oncontextmenu = () => false;

        const simple_coordinates_canvas_width = 300;
        simple_coordinates_canvas.style.width = `${simple_coordinates_canvas_width}px`;
        simple_coordinates_canvas.style.height = 'auto'; // set height to auto
        simple_coordinates_canvas.oncontextmenu = () => false;

        // -----------------------------------------------
        // link element to callbacks
        // -----------------------------------------------
        preview_canvas.addEventListener('mousedown', callback_canvas_clicks);
        button_submit_image.addEventListener('click', callback_submit_image);
        // window.addEventListener('keydown', callback_keyboard);

        // -----------------------------------------------
        // callback functions and helpers
        // -----------------------------------------------
        function update_canvas_image(canvas, image_url) 
        {
            const canvas_context = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() 
            {
                // clear canvas
                canvas_context.clearRect(0, 0, canvas.width, canvas.height); 

                // set canvas size to image size
                canvas.width = img.width;
                canvas.height = img.height;

                // draw image on the canvas
                canvas_context.drawImage(img, 0, 0, canvas.width, canvas.height); 
                
                // free the object URL
                URL.revokeObjectURL(image_url);
            };
            img.src = image_url; // set image source to the URL
        }
        
        
        async function callback_submit_image() 
        {
            // ensure a file is selected
            if (file_input.files.length === 0) 
            {
                console.error('Please upload a file first.');
                return;
            }

            // reset clicks
            leftClicks = [];
            rightClicks = [];

            // show the file in the convas
            const file = file_input.files[0];
            const reader = new FileReader();
            reader.onload = function(event)
            {
                update_canvas_image(preview_canvas, event.target.result); // update canvas with the image
            };
            reader.readAsDataURL(file); // read file as data URL
            
            // ----------------------------------------------------
            // get task_id from server
            // ----------------------------------------------------
            
            // send file to server and get task_id
            const form = new FormData();
            form.append('file', file);
            const response = await fetch('/add_task/', {method: 'POST', body: form});

            // ensure the response is ok
            if (!response.ok)
            {
                console.error('Failed to upload file:', response.statusText);
                return;
            }

            // get the task_id from the response
            const data = await response.json();
            task_id = data.task_id;
        }

        async function callback_canvas_clicks(event) 
        {                        
            // skip if no task_id
            if (!task_id)
            {
                console.error('No task_id available. Please upload a file first.');
                return;
            }

            // compute position
            const preview_canvas_rectangle = preview_canvas.getBoundingClientRect(); // update the rectangle entity every time
            const screen_x = event.clientX;
            const screen_y = event.clientY;
            const rect_x = screen_x - preview_canvas_rectangle.left; // relative to canvas rectange
            const rect_y = screen_y - preview_canvas_rectangle.top; // relative to canvas rectange
            const canvas_x = rect_x * (preview_canvas.width / preview_canvas_rectangle.width);
            const canvas_y = rect_y * (preview_canvas.height / preview_canvas_rectangle.height);
            const int_canvas_x = Math.round(canvas_x);
            const int_canvas_y = Math.round(canvas_y);

            // get left or right click
            const left = event.button === 0;

            // --- log ---
            console.log(`${left? 'Left' : 'Right'} click at (${int_canvas_x}, ${int_canvas_y}) on task_id: ${task_id}`);
            // -----------

            // create a form with the click data
            const form = new FormData();
            form.append('task_id', task_id); // add task_id to the form
            form.append('x', int_canvas_x.toString());
            form.append('y', int_canvas_y.toString());
            form.append('left', left ? 'true' : 'false');
            const response = await fetch('/send_clicks/', {method: 'POST', body: form});

            // ensure the response is ok
            if (!response.ok) 
            {
                console.error('Failed to send click data:', response.statusText);
                return;
            }
            
            // // read zip
            // const zipBlob = await response.blob();
            // const zip = await JSZip.loadAsync(zipBlob);

            // // Draw preview if it exists
            // if (zip.files["preview.png"]) 
            // {
            //     const previewImage = await zip.files["preview.png"].async("blob");
            //     const previewImageUrl = URL.createObjectURL(previewImage);
            //     update_canvas_image(preview_canvas, previewImageUrl);
            // } 

            // // Draw simple coordinates if it exists
            // if (zip.files["coordinates.png"]) 
            // {
            //     const coordinatesImage = await zip.files["coordinates.png"].async("blob");
            //     const coordinatesImageUrl = URL.createObjectURL(coordinatesImage);
            //     update_canvas_image(simple_coordinates_canvas, coordinatesImageUrl);
            // } 

            // returned json 
            const data = await response.json();
            const preview_image_base64 = data.preview_image;
            const simple_coordinates_image_base64 = data.simple_coordinate_image;
            
            if (preview_image_base64) 
            {
                const previewImageUrl = `data:image/png;base64,${preview_image_base64}`;
                update_canvas_image(preview_canvas, previewImageUrl);
            } 
            
            if (simple_coordinates_image_base64) 
            {
                const coordinatesImageUrl = `data:image/png;base64,${simple_coordinates_image_base64}`;
                update_canvas_image(simple_coordinates_canvas, coordinatesImageUrl);
            }
        }

        // async function callback_keyboard(event)
        // {
        //     if (event.key === 'Enter')
        //     {
        //         // get data
        //         const file = file_input.files[0];
        //         const clicks = JSON.stringify({left: leftClicks, right: rightClicks});

        //         // convert both to form
        //         const form = new FormData();
        //         form.append('file', file);
        //         form.append('clicks', clicks);

        //         // submit to server and get task_id
        //         const {task_id} = await fetch('/uploads/', {method:'POST', body:form}).then(r=>r.json());

        //         // poll for result
        //         let result;
        //         do 
        //         { 
        //             result = await fetch(`/result/${task_id}`).then(r=>r.json()); 
        //             await new Promise(r=>setTimeout(r,1000)); 
        //         }
        //         while (!result.ready);
                
        //         // show result in the pre named blueprint
        //         preformatted_text.textContent = result.blueprint;

        //         // draw the image on the canvas
        //         const img = new Image(); 
        //         img.src = `/static/results/${result.image}`;
        //         img.onload = () => preview_canvas_context.drawImage(img,0,0);
        //     }
        // }
    </script>
</body>
</html>
